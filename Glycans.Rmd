```{r Libraries}

## Load the libraries ##
library(tidyverse)
library(readxl)
library(purrr)
library(broom)
library(ggtext)
library(patchwork)

```

```{r Load the data}

AGP_Data <- read_xlsx("~/SLE/Glycans/Data/LN_AGP_glycopeptide-data.xlsx")
C3_Data <- read_xlsx("~/SLE/Glycans/Data/LN_C3_glycopeptide_data.xlsx")
Serum_Data <- read_xlsx("~/SLE/Glycans/Data/LN_serum_glycome_data.xlsx")
Decreased_data <- read_xlsx("~/SLE/Glycans/Data/decreased.xlsx")
Increased_data <- read_xlsx("~/SLE/Glycans/Data/increased.xlsx")
IgG_FAB_Data <- read_xlsx("~/SLE/Glycans/Data/LN_total_IgG_Fab_data.xlsx")
IgG_FC_Data <- read_xlsx("~/SLE/Glycans/Data/LN_total_IgG_Fc_data.xlsx")
IgG_Meta <- read_xlsx("~/SLE/Glycans/Data/LN_total_IgG_glycomedata.xlsx")


```


```{r Prep slightly}

Comparators <- c("AI", "CI", "S-creatinine", "eGFR", "UPCR", "albumin", "extra-renal", "Renal Impairment")

Comparator_Values <- Increased_data %>%
  rename(ID = `Patient number`, Time_point = `Time point`) %>%
  select(ID, Time_point, any_of(Comparators)) %>%
  rename(SLEDAI2K = `Renal Impairment`,
         SLEDAI2K_extra = `extra-renal`,
         S_creatinine = `S-creatinine`) %>%
  mutate(Identification = paste0(ID, " ", Time_point)) %>%
  select(-c(ID, Time_point)) %>%
  select(Identification, everything()) %>%
  column_to_rownames("Identification") %>%
  mutate(AI = as.numeric(AI),
         CI = as.numeric(CI))

```

```{r Make dtaaframes long}

Dataframes <- list(AGP = AGP_Data, 
                   C3 = C3_Data, 
                   Serum = Serum_Data,
                   Fab = IgG_FAB_Data, 
                   Fc = IgG_FC_Data)

Process_DFs <- function(df){
  df %>% 
    select(-c(Sample, `ID_St Luc`)) %>% 
    rename(ID = `Patient number`, Time_point = `Time point`) %>% 
    mutate(across(.cols = -c(ID, Time_point), .fns  = as.numeric)) %>% 
    pivot_longer(cols = -c(ID, Time_point), names_to   = "Marker", values_to  = "Value")
}

Long_Dataframes <- map(Dataframes, Process_DFs)

```

```{r Get the direction of each marker}

Directions_List <- imap(Long_Dataframes, ~ {
  df <- .x
  prefix <- .y
  
  df %>% 
    mutate(Marker_Timepoint = paste0(Marker, Time_point)) %>%
    group_by(Marker_Timepoint) %>%
    summarise(Mean = mean(Value, na.rm = TRUE), .groups = "drop") %>%
    extract(col = Marker_Timepoint, 
          into = c("Marker", "Timepoint"), 
          regex = "(.+)(T0|T12)$") %>% 
    pivot_wider(names_from = "Timepoint", values_from = "Mean") %>% 
    mutate(Direction = case_when(T12 > T0 ~ "Increase", 
                                 T12 < T0 ~ "Decrease", 
                                 TRUE ~ NA), 
           Marker = paste0(prefix, "_", Marker),
           Origin = prefix) %>% 
    select(Marker, Direction, Origin)
})

Directions <- bind_rows(Directions_List)

```

```{r Perform the tests}

Paired_Tests <- function(df){ df %>% 
  pivot_wider(names_from = "Time_point", values_from = "Value", names_prefix = "Value_") %>% 
  group_by(Marker) %>% 
  summarise(Pairs = n_distinct(ID),
            Test = list(wilcox.test(Value_T12, 
                                    Value_T0, 
                                    paired = TRUE, 
                                    exact = FALSE)), 
                        .groups = "drop") %>% 
  mutate(Results = map(Test, broom::tidy)) %>% 
  unnest(Results) %>% 
  select(Marker, Pairs, statistic, p.value, method)
}

Test_Results <- imap(Long_Dataframes, ~Paired_Tests(.x) %>% 
                       mutate(Marker = paste0(.y, "_", Marker)))

Test_Results <- bind_rows(Test_Results, .id = "Origin")

```

```{r Combine the direction with the tests}

Results_Total <- Test_Results %>% inner_join(Directions, by = c("Origin", "Marker"))

Dataframes_Final <- imap(
  Long_Dataframes, ~ .x %>% 
      mutate(Marker = paste0(.y, "_", Marker), 
             Origin = .y)) %>% 
  bind_rows(., .id = "Origin") %>% 
  select(ID, Origin, everything())

Results_Sign <- Results_Total %>% 
  filter(p.value < 0.05)

Dataframes_Final_Sign <- Dataframes_Final %>% 
  filter(Marker %in% Results_Sign$Marker)

```

```{r Correlation analysis}

Dataframes_Final_Sign_Wide <- Dataframes_Final_Sign %>% 
  mutate(ID = paste0(ID, " ", Time_point)) %>% 
  select(-c(Time_point, Origin)) %>% 
  pivot_wider(id_cols = ID, names_from = "Marker", values_from = "Value") %>% 
  column_to_rownames(var = "ID")

# Correlations <- cor(Dataframes_Final_Sign_Wide, 
#                     Comparator_Values, 
#                     method = "spearman", 
#                     use = "pairwise.complete.obs") %>% 
#   as.data.frame() %>%
#   rownames_to_column(var = "Marker") %>% 
#   pivot_longer(cols = -Marker, 
#                names_to = "Variable", 
#                values_to = "Correlation") %>% 
#   mutate(Origin = sub("_.*$", "", Marker)) %>% 
#   inner_join(Directions, by = c("Marker", "Origin"))


DFs_Combined <- cbind(Dataframes_Final_Sign_Wide, Comparator_Values)

Correlations <- expand_grid(Marker = colnames(Dataframes_Final_Sign_Wide), 
              Variable = colnames(Comparator_Values)) %>% 
  mutate(test = map2(Marker, Variable, ~ cor.test(DFs_Combined[[.x]], DFs_Combined[[.y]], 
                                                  method = "spearman", exact  = FALSE)),
         rho     = map_dbl(test, "estimate"), 
         p.value = map_dbl(test, "p.value", )) %>%
  mutate(P_adjust = p.adjust(p.value, method = "BH")) %>% 
  select(-test) %>% 
  mutate(Origin = sub("_.*$", "", Marker)) %>% 
  inner_join(Directions, by = c("Marker", "Origin")) %>% 
  rename(Correlation = "rho") %>% 
  mutate(Significance = case_when(P_adjust < 0.05 ~ "*"))


```

```{r Correlations visualisation}

Main_plot <- ggplot(Correlations, aes(x = Variable, y = Marker, fill = Correlation)) +
  geom_tile(color = "white", width = 1, height = 1) +
  scale_fill_gradient2(low = "dodgerblue", mid = "white", high = "firebrick", 
                       midpoint = 0, breaks = seq(-1, 1, by = 0.5), 
                       guide = guide_colorbar(order = 1, title.position = "top", title.hjust = 0.5, 
                                              title = "Spearman<br>Correlation", title.theme = element_markdown(face = "bold"))) +
  facet_grid(Origin ~., scales = "free_y", space = "free_y", switch = "x") +
  # geom_text(aes(label = round(Correlation, 2)), size = 3) +
  geom_text(aes(label = Significance)) +
  scale_y_discrete(labels = function(x) gsub("^[^_]*_", "", x)) +
  scale_x_discrete(labels = function(x) {
    x <- gsub("_", " ", x)
    x <- gsub("SLEDAI2K extra", "SLEDAI2K<br>extra", x)
    x }) +
  labs(title = "Heatmap of Glycan Correlations", x = NULL, y = NULL) +
  theme_minimal(base_size = 12) +
  theme(strip.placement = "outside",
        strip.text.y.right = element_text(angle = 0, hjust = 0, vjust = 0.5, face  = "bold"),
    axis.text.x = element_markdown(angle = 0, hjust = 0.5, face = "bold"), 
    axis.text.y = element_text(size = 8, face = "bold"),
    panel.grid  = element_blank(), 
    panel.spacing = unit(0.5, "lines"), 
    plot.title = element_text(face = "bold"))

ggsave(Main_plot, filename = "~/SLE/Glycans/Plots/Glycans_Correlations.jpeg",
       width = 10, height = 14, dpi = 300)

```

```{r}

dir_plot <- Correlations %>%
  distinct(Origin, Marker, Direction) %>% 
  ggplot(., aes(x = 1, y = Marker, fill = Direction)) +
  geom_tile(color = "white", width = 1, height = 1) +
  facet_grid(Origin ~ ., scales = "free_y", space  = "free_y", switch = "y") +
  scale_fill_manual(values = c("Increase" = "mediumspringgreen",
                               "Decrease" = "purple", 
                               "No change"  = "grey80"), 
                    name = "T12 vs T0", 
                    guide = guide_legend(order = 2, title.position = "top", 
                                         title.hjust = 0.5, label.position = "right")) +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  theme_void() +
  theme(strip.text.y = element_blank(),
        strip.text.y.right = element_text(angle = 0, hjust = 0),
        legend.position = "bottom",
        legend.title = element_text(face = "bold"),
        plot.margin = margin(0,0,0,0))

combined <- dir_plot + Main_plot + 
  plot_layout(widths = c(0.1, 1), guides = "collect") +    # adjust 0.15 to taste
  plot_annotation(theme = theme(plot.margin = margin(5,5,5,5))) +
  theme(legend.box = "vertical", legend.title.align = 0.5)


```

```{r}

```

