```{r Load the libraries}

library(tidyverse)
library(ggplot2)
library(readxl)
library(survival)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(scales)
library(broom)
library(coxphf)

```


```{r Load event times for renal impairment}

Patients <- read_csv("~/SLE/Glycans/Output_Data/Glycans_marker_data_total.csv") %>% 
  select(ID) %>% 
  distinct()

Survival_Dataframe <- read_xlsx("~/SLE/Glycans/Data/Survival_Data.xlsx") %>% 
  mutate(Biopsy_Date = dmy(Date_Biopsy), 
         imp_date = case_when(`Renal Impairment` %in% c("0","1", NA) ~ NA_character_, TRUE ~ `Renal Impairment`),
         imp_date = dmy(imp_date))

Survival_Data <- Survival_Dataframe %>% group_by(Patients) %>% 
    summarise(Start = Biopsy_Date[Timing_Biopsy == "T0"], 
              Last = Biopsy_Date[Timing_Biopsy == "T12"], 
              Event_Date = imp_date %>% 
                na.omit() %>% 
                first(),
              Event = if_else(!is.na(Event_Date) & Event_Date <= Last, 1L, 0L),
              End = if_else(Event == 1L, Event_Date, Last),
              Time = as.numeric(difftime(End, Start, units = "days"))) %>% 
    ungroup() %>% 
  rename(ID = Patients)


  
```

```{r Load glycans and join}

Marker_DF <- read_csv(file = "~/SLE/Glycans/Output_Data/Glycans_marker_data_total.csv")

Glycans_Data <- Marker_DF %>%
  group_by(Time_point, Marker) %>%
  
  ## Since we have four samples with NA values we will replace them with the median value for each marker ##
  ## Too few samples too drop (19 total, so 4 is quite a large amount) ##
  
  mutate(Marker_Median = median(Value, na.rm = TRUE), 
         Value = if_else(is.na(Value), Marker_Median, Value)) %>% 
  select(-Marker_Median) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(ID, Origin, Marker), names_from = Time_point, values_from = Value) %>% 
  mutate(Delta = T12 - T0, 
         Log2FC = log2(T12/T0))

Joint_DF <- Survival_Data %>% 
  inner_join(Glycans_Data, by = "ID")

Markers <- Joint_DF %>% 
  pull(Marker)

```

```{r Perform the Cox regressions - Univariate}

Cox_formula_all <- reformulate(Markers, response = "Surv(Time, Event)")

Cox_Results_Uni_Total <- Joint_DF %>% 
  select(ID, Time, Event, Marker, T0, T12, Delta) %>% 
  pivot_longer(cols = -c(ID, Time, Event, Marker), names_to = "Comparison", values_to = "Value") %>% 
  group_by(Comparison, Marker) %>% 
  nest() %>% 
  mutate(Fit = map(data, ~ coxph(Surv(Time, Event) ~ Value, data = .x)),
         Tidy = map(Fit, ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE))) %>%
  unnest(Tidy) %>%
  select(Comparison, Marker, estimate, std.error, statistic, p.value, conf.low, conf.high, hazard_ratio = estimate) %>%
  arrange(Comparison, p.value) %>% 
  mutate(FDR = p.adjust(p.value, method = "fdr")) %>% 
  ungroup() 

Top_Markers_strict <- Cox_Results_Uni_Total %>% 
  filter(p.value < 0.05) 

Top_Markers_lax <- Univariate_Cox %>% 
  filter(p.value < 0.1) 

Multi_Cox_Strict <- coxph(reformulate(Top_Markers_T0_strict, response = "Surv(Time, Event)"), 
                          data = Joint_imp)

Multi_Cox_Lax <- coxph(reformulate(Top_Markers_T0_lax, response = "Surv(Time, Event)"), 
                          data = Joint_imp)

# Multi_Cox_Firth_Strict <- coxphf(reformulate(Top_Markers_T0_strict, response = "Surv(Time, Event)"), 
#                           data = Joint_imp, maxit = 200, maxstep = 0.2)
# 
# Multi_Cox_Firth_Lax <- coxphf(reformulate(Top_Markers_T0_lax, response = "Surv(Time, Event)"), 
#                           data = Joint_imp, maxit = 200, maxstep = 0.2)

```


```{r Perform the Cox regressions - Multivariate}

Top_Markers_strict <- Cox_Results_Uni_Total %>% 
  filter(p.value < 0.05) 

Top_Markers_lax <- Univariate_Cox %>% 
  filter(p.value < 0.1) 

Cox_Results_Multi_Total <- Joint_DF %>% 
  select(ID, Time, Event, Marker, T0, T12, Delta) %>% 
  pivot_longer(cols = -c(ID, Time, Event, Marker), names_to = "Comparison", values_to = "Value") %>% 
  group_by(Comparison) %>% 
  nest() %>% 
  mutate(Fit = map(data, ~ coxph(Surv(Time, Event) ~ Value, data = .x)),
         Tidy = map(Fit, ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE))) %>%
  unnest(Tidy) %>%
  select(Comparison, Marker, estimate, std.error, statistic, p.value, conf.low, conf.high, hazard_ratio = estimate) %>%
  arrange(Comparison, p.value) %>% 
  mutate(FDR = p.adjust(p.value, method = "fdr")) %>% 
  ungroup() 

Run_multi_cox <- function(Top_Markers) {
Joint_DF %>% 
  select(ID, Time, Event, Marker, T0, T12, Delta) %>% 
  pivot_longer(cols = -c(ID, Time, Event, Marker), names_to = "Comparison", values_to = "Value") %>% 
  group_by(Comparison) %>% 
  nest() %>% 
  mutate(Markers = map(Comparison, ~ Top_Markers %>% 
                         filter(Comparison == .x) %>% 
                         pull(Marker)), 
         
         Data = map2(data, Markers, ~ .x %>% 
                       filter(Marker %in% .y) %>% 
                       select(ID, Time, Event, Marker, Value) %>% 
                       pivot_wider(id_cols = c(ID, Time, Event), names_from = Marker, values_from = Value)), 
         
         Formula = map(Markers, ~ reformulate(.x, response = "Surv(Time, Event)")), 
         
         Fit = map2(Formula, Data, ~ coxph(.x, data = .y)), 
         
         Tidy = map(Fit, ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE))) %>% 
    unnest(Tidy) %>% 
    select(Comparison, Marker = term, estimate, std.error, statistic, 
           p.value, conf.low, conf.high, hazard_ratio = estimate) %>% 
    group_by(Comparison) %>% 
    mutate(FDR = p.adjust(p.value, method = "fdr")) %>% 
    ungroup()
    
}

Cox_Results_Multi_Total_strict <- Run_multi_cox(Top_Markers_strict)

# Multi_Cox_Firth_Strict <- coxphf(reformulate(Top_Markers_T0_strict, response = "Surv(Time, Event)"), 
#                           data = Joint_imp, maxit = 200, maxstep = 0.2)

```









```{r}

cox <- coxph(Surv(Time, Event) ~ 1, data = Survival_Data)
km_fit <- survfit(cox)

Survival_plot <- autoplot(km_fit, surv.geom = "step", 
         censor.geom = "point", 
         censor.shape = 3, 
         censor.size = 2, 
         censor.colour = "firebrick",
         conf.int = TRUE, 
         conf.int.fill = "royalblue", 
         conf.int.colour = "midnightblue",
         conf.int.style = "ribbon", 
         conf.int.alpha = 0.2) +
  theme_minimal(base_size = 14, base_family = "sans") +
  labs(title = "Kaplan Meier curve",
       subtitle = "Renal impairment probability over time",
       x = "Days since baseline", 
       y = "Renal impairment probability") +
  scale_y_continuous(labels = percent_format(accuracy = 1),
                     limits = c(0, 1), 
                     expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey90"),
        plot.title = element_text(face = "bold", size = 16),
        plot.subtitle = element_text(size = 12))

ggsave(filename = "~/SLE/Glycans/Plots_2/Figure_6_Survival/Survival_Plot_Basic.jpeg",
       plot = Survival_plot, width = 10, height = 6, dpi = 300, device = "jpeg")

```

```{r}


Joint_long <- Joint_imp %>% 
  select(ID, Event, Time, any_of(Glycans_Data$Marker)) %>% 
  inner_join(Glycans_Data, by = "ID")

Cox_Results_Uni <- Joint_long %>% 
  group_by(Marker) %>% 
  nest() %>% 
  ungroup() %>% 
  crossing(Value_Variable = c("T0", "T12", "Delta", "Log2FC")) %>% 
  mutate(Fit = map2(data, Value_Variable, ~ 
                      coxph(reformulate(.y, response = "Surv(Time, Event)"), data = .x))) %>% 
  mutate(Tidied = map2(Fit, Value_Variable, ~ broom::tidy(.x) %>% filter(term == .y))) %>% 
  select(Marker, Tidied) %>%
  unnest(Tidied) 

Cox_Sign_Markers <- Cox_Results_Uni %>% 
  filter(p.value < 0.05) %>% 
  group_by(term) %>% 
  summarise(markers = unique(Marker), .groups = "drop")

Cox_Results_Multi <- Cox_Sign_Markers %>% 
  filter(term %in% c("T0", "T12", "Delta")) %>%  
  mutate(Data = map2(term, markers, ~ {
    Joint_long %>%
      filter(Marker %in% .y) %>%
      select(ID, Time, Event, Marker, any_of(.x)) %>%
      pivot_wider(id_cols = c(ID, Time, Event),
                  names_from = Marker,
                  values_from = .x)}),
    Formula = map(markers, ~ reformulate(.x, response = "Surv(Time, Event)")),
    Fit = map2(Formula, Data, ~ coxph(.x, data = .y))) %>%
  # select(term, markers, Fit) %>% 
  mutate(Tidy = map(Fit, ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE) %>% 
                      rename(Model = term))) %>% 
  unnest(Tidy)


Test_1 <- Cox_Sign_Markers %>% 
  filter(term == "Delta") %>% 
  pull(markers)

Delta_DF <- Joint_long %>% 
  select(ID, Time, Event, Marker, Delta) %>% 
  pivot_wider(id_cols = c(ID, Time, Event), names_from = Marker, values_from = Delta)

coxph(reformulate(Test_1, response = "Surv(Time, Event)"), data = Delta_DF)
  
```


```{r}

X <- scale(model.matrix(Formula_2, data = Joint_imp)[, -1])

cm2 <- cor_mat
diag(cm2) <- NA
which(abs(cm2) > 0.95, arr.ind=TRUE)

Top_Markers_T0_strict_2 <- Top_Markers_T0_strict[! Top_Markers_T0_strict %in% c("Serum_S4", "Serum_GP38", "C3_CIIIGIRMN1N2H9")]
Formula_2 <- reformulate(Top_Markers_T0_strict_2, response = "Surv(Time, Event)")

fit_2 <- aareg(Formula_2, data = Joint_imp, nmin = 1)
autoplot(fit_2)
fit_2_cox <- coxph(Formula_2, data = Joint_imp)
zph <- cox.zph(fit_2)

```


```{r}



```























